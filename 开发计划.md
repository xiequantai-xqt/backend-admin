# 开发计划

## 注册与登录

| 模板       | 功能 | 进度 |
| ---------- | ---- | ---- |
| 注册与登录 | 注册 |      |
|            | 登录 |      |

## 麻辣烫

| 模块         | 功能                                                         | 后端进度 |
| ------------ | ------------------------------------------------------------ | -------- |
| 库存管理     | 手动添加：每个食材都要收录进表格                             |          |
|              | 食材详情：每个食材都能查阅每个月的折线图                     |          |
|              | Excel添加：做一个模板，支持Excel导入，这是以后的主要功能     |          |
| 消耗量排行榜 | 根据每个月的食材消耗量，做一个排行榜，用表格形式呈现（Excel导出） |          |
| 外卖管理     | 展示每个月的评分折线图（美团、饿了么、京东）                 |          |
|              | 差评做出一个列表，每天都录入进去，包含因素：日期、差评类型、差评内容、原因、如何处理 |          |

# 连接MongoDB

以下是**从头开始**连接 Mongoose 到 MongoDB 的详细步骤，包括安装、配置和测试。我会提供具体命令和代码示例。

## 步骤 1：安装 MongoDB 本地服务（如果尚未安装）

### 对于 Windows 用户

1. 下载 MongoDB Community Edition：https://www.mongodb.com/try/download/community

2. 安装时选择"Add to PATH"选项

3. 创建数据目录：`C:\data\db`（如果不存在）

4. 启动 MongoDB 服务：

   > 进入“C:\Program Files\MongoDB\Server\8.2\bin>”，运行

   ```bash
   mongod
   ```

   保持此命令行窗口打开，不要关闭它（这是 MongoDB 服务）

### 对于 macOS 用户

```bash
brew tap mongodb/brew
brew install mongodb-community
mkdir -p /usr/local/var/mongodb
mongod --dbpath /usr/local/var/mongodb
```

## 步骤 2：安装 Mongoose 依赖

在项目根目录（包含 package.json 的目录）中运行：

```bash
npm install mongoose
```

## 步骤 3：创建数据库连接文件

在项目根目录创建 `db.js` 文件：

```javascript
const mongoose = require('mongoose');

// 连接 MongoDB
const connectDB = async () => {
  try {
    // 使用你的 MongoDB 连接字符串
    // 本地默认连接字符串
    const conn = await mongoose.connect('mongodb://localhost:27017/your-database-name', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      useCreateIndex: true,
      useFindAndModify: false
    });

    console.log(`MongoDB Connected: ${conn.connection.host}`);
  } catch (err) {
    console.error(`Error: ${err.message}`);
    process.exit(1);
  }
};

module.exports = connectDB;
```

> **重要提示**：将 `your-database-name` 替换为您的数据库名称（如 `myappdb`）

## 步骤 4：创建 .env 文件

在项目根目录创建 `.env` 文件：

```env
MONGODB_URI=mongodb://localhost:27017/your-database-name
```

> **注意**：如果使用本地 MongoDB，这个连接字符串是默认的。如果您使用 MongoDB Atlas（云数据库），需要替换为从 Atlas 获取的连接字符串。

## 步骤 5：配置主应用文件

在您的主应用文件（如 `app.js` 或 `server.js`）中：

```javascript
const express = require('express');
const connectDB = require('./db'); // 引入数据库连接
const dotenv = require('dotenv'); // 用于加载 .env 文件

dotenv.config(); // 加载 .env 文件中的环境变量

const app = express();

// 连接数据库
connectDB();

// 其他中间件和路由设置...
// 例如：
app.get('/', (req, res) => {
  res.send('API is running...');
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => console.log(`Server running on port ${PORT}`));
```

## 步骤 6：创建 Schema 和 Model

在 `models/User.js` 中创建用户模型：

```javascript
const mongoose = require('mongoose');

// 定义用户 Schema
const UserSchema = new mongoose.Schema({
  username: {
    type: String,
    required: true,
    unique: true
  },
  password: {
    type: String,
    required: true
  },
  email: {
    type: String,
    required: true,
    unique: true
  },
  createdAt: {
    type: Date,
    default: Date.now
  }
});

// 创建模型
module.exports = mongoose.model('User', UserSchema);
```

## 步骤 7：测试连接

1. 确保 MongoDB 服务正在运行（步骤 1 中的 `mongod` 窗口保持打开）

2. 在终端运行：

   ```bash
   npm start
   ```

   或

   ```bash
   npm run dev
   ```

3. 检查控制台输出，应该看到类似这样的信息：

   ```
   MongoDB Connected: localhost:27017
   Server running on port 5000
   ```

## 步骤 8：验证数据库连接

1. 在 MongoDB 命令行中验证：

   ```bash
   mongo
   ```

   然后在 MongoDB shell 中：

   ```javascript
   use your-database-name
   show collections
   ```

   如果您有 `users` 集合，应该能看到它。

2. 或者在您的 Express 应用中添加一个简单的测试路由：

   ```javascript
   // 在 app.js 中添加
   app.get('/test', async (req, res) => {
     try {
       const count = await mongoose.connection.db.collection('users').countDocuments();
       res.json({ message: `Connected to MongoDB, total users: ${count}` });
     } catch (error) {
       res.status(500).json({ error: error.message });
     }
   });
   ```

## 常见问题解决

### 问题 1："MongoDB connection error: connect ECONNREFUSED 127.0.0.1:27017"

**解决方法**：

1. 确保 MongoDB 服务已启动（步骤 1 中的 `mongod` 窗口）
2. 检查连接字符串是否正确（默认是 `mongodb://localhost:27017/your-database-name`）

### 问题 2：无法找到模块 'dotenv'

**解决方法**：

```bash
npm install dotenv
```

### 问题 3：连接超时

**解决方法**：
在连接字符串中添加 `?connectTimeoutMS=30000`：

```javascript
const conn = await mongoose.connect('mongodb://localhost:27017/your-database-name?connectTimeoutMS=30000', { ... });
```

## 完整项目结构示例

```
your-project/
├── .env
├── db.js
├── models/
│   └── User.js
├── controllers/
│   └── userController.js
├── routes/
│   └── auth.js
├── app.js
└── package.json
```

## 测试连接

1. 启动 MongoDB 服务：`mongod`

2. 启动应用：`npm start`

3. 在浏览器中访问 `http://localhost:5000/test`

4. 应该看到类似这样的响应：

   ```json
   {
     "message": "Connected to MongoDB, total users: 0"
   }
   ```

完成这些步骤后，您的 Express 应用应该能够成功连接到 MongoDB 数据库。如果您按照步骤操作，应该能解决 "Operation users.findOne() buffering timed out after 10000ms" 这个问题。

如果还有问题，检查：

1. MongoDB 服务是否在运行
2. 连接字符串是否正确
3. 是否正确导入了 `db.js` 并调用了 `connectDB()`
4. 数据库名称是否匹配

希望这个指南能帮助您成功连接 Mongoose 到 MongoDB！